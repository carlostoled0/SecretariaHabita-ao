<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretaria de Habitação</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .btn-group-custom {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .table thead {
            background-color: #343a40;
            color: #fff;
        }
        .table td, .table th {
            vertical-align: middle;
            font-size: 0.9rem;
        }
        .form-select-sm {
            font-size: 0.8rem;
        }
        td:nth-child(1) {
            width: 140px;
        }
        td:nth-child(6), th:nth-child(6) {
            width: 200px;
        }
    </style>
</head>
<body>
<div class="container my-4">
    <h1>Simulador de Regularização Fundiária</h1>
    <div class="mb-3 btn-group-custom">
        <button class="btn btn-success" onclick="window.open('status.html?status=Ativo', '_blank')">Ativo</button>
        <button class="btn btn-warning" onclick="window.open('status.html?status=Cartório', '_blank')">Cartório</button>
        <button class="btn btn-primary" onclick="window.open('status.html?status=Vistoria', '_blank')">Vistoria</button>
        <button class="btn btn-danger" onclick="window.open('status.html?status=Sem solução', '_blank')">Sem solução</button>
        <button class="btn btn-secondary" onclick="carregarDados()">Atualizar Dados</button>
    </div>

    <table class="table table-bordered shadow-sm">
        <thead>
        <tr>
            <th>Status</th>
            <th>Interessado/Requerente</th>
            <th>CPF</th>
            <th>Nº Processo/Protocolo</th>
            <th>Data Abertura</th>
            <th>Telefone</th>
        </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

<script>
let dados = [];

function carregarDados(statusFiltro = null) {
    document.getElementById("tabela").innerHTML = "";
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSy01pb1a-_Nq2BY7Qaf5TpEkawEcxd7e3PyR8a5eS0DC2VE8EaB8iSdXXnNy8b2fOxW-vO_vkAAMsI/pub?gid=1097337137&single=true&output=csv')
        .then(response => response.text())
        .then(csvText => {
            const linhas = csvText.split('\n');
            linhas.splice(0, 2);
            dados = linhas.map((linha, index) => {
                const colunas = linha.split(',');
                return {
                    id: index,
                    nome: colunas[5],
                    cpf: colunas[6],
                    processo: colunas[23],
                    data: colunas[24],
                    telefone: colunas[8],
                    status: localStorage.getItem('status-' + index) || 'Selecionar'
                };
            });
            exibirDados(statusFiltro);
        });
}

function exibirDados(statusFiltro) {
    document.getElementById("tabela").innerHTML = "";
    dados.forEach(requerente => {
        adicionarLinha(requerente);
    });
}

function adicionarLinha(requerente) {
    const tabela = document.getElementById("tabela");
    const novaLinha = document.createElement('tr');
    novaLinha.innerHTML = `
        <td>
            <select class="form-select form-select-sm" onchange="alterarStatus(${requerente.id}, this)">
                <option ${requerente.status === 'Selecionar' ? 'selected' : ''}>Selecionar</option>
                <option ${requerente.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                <option ${requerente.status === 'Cartório' ? 'selected' : ''}>Cartório</option>
                <option ${requerente.status === 'Vistoria' ? 'selected' : ''}>Vistoria</option>
                <option ${requerente.status === 'Sem solução' ? 'selected' : ''}>Sem solução</option>
            </select>
        </td>
        <td>${requerente.nome.toUpperCase()}</td>
        <td>${requerente.cpf}</td>
        <td>${requerente.processo}</td>
        <td>${requerente.data}</td>
        <td>${requerente.telefone}</td>`;

    tabela.appendChild(novaLinha);
}

function alterarStatus(id, select) {
    const novoStatus = select.value;
    localStorage.setItem('status-' + id, novoStatus);
    dados[id].status = novoStatus;
}

function obterParametro(nome) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(nome);
}

window.onload = function() {
    const status = obterParametro('status');
    carregarDados(status);
};
</script>
</body>
</html>
