<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Regularização Fundiária</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-4">
    <h3 class="mb-4">Regularização Fundiária - Leopoldina/MG</h3>
    <input class="form-control mb-3" type="file" id="pdf-upload" accept="application/pdf">

    <div class="mb-3">
        <button class="btn btn-success" onclick="window.open('status.html?status=Ativo', '_blank')">Ativo</button>
        <button class="btn btn-warning" onclick="window.open('status.html?status=Cartório', '_blank')">Cartório</button>
        <button class="btn btn-primary" onclick="window.open('status.html?status=Vistoria', '_blank')">Vistoria</button>
        <button class="btn btn-danger" onclick="window.open('status.html?status=Sem solução', '_blank')">Sem solução</button>
    </div>

    <pre id="texto-extraido" class="bg-light p-3"></pre>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Interessado/Requerente</th>
            <th>CPF</th>
            <th>Nº Processo/Protocolo</th>
            <th>Data Abertura</th>
            <th>Telefone</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

<script>
    document.getElementById('pdf-upload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async function () {
                const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const { data: { text } } = await Tesseract.recognize(canvas, 'por');

                document.getElementById('texto-extraido').textContent = text;

                const nome = extrairEntre(text, 'Nome:', 'CPF:');
                const cpf = extrairEntre(text, 'CPF:', 'Processo:');
                const processo = extrairEntre(text, 'Processo:', 'Data:');
                const data = extrairEntre(text, 'Data:', 'Telefone:');
                const telefone = extrairEntre(text, 'Telefone:', 'Fim');

                adicionarLinha(nome, cpf, processo, data, telefone);
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function extrairEntre(texto, inicio, fim) {
        const regex = new RegExp(inicio + "(.*?)" + fim);
        const resultado = texto.match(regex);
        return resultado ? resultado[1].trim() : '';
    }

    function adicionarLinha(nome, cpf, processo, data, telefone, status = 'Selecionar') {
        const tabela = document.getElementById("tabela");
        const novaLinha = document.createElement('tr');
        novaLinha.innerHTML = `<td>${nome}</td><td>${cpf}</td><td>${processo}</td><td>${data}</td><td>${telefone}</td><td><select class="form-select" onchange="mudarStatus(this, '${processo}')"><option ${status === 'Selecionar' ? 'selected' : ''}>Selecionar</option><option ${status === 'Ativo' ? 'selected' : ''}>Ativo</option><option ${status === 'Cartório' ? 'selected' : ''}>Cartório</option><option ${status === 'Vistoria' ? 'selected' : ''}>Vistoria</option><option ${status === 'Sem solução' ? 'selected' : ''}>Sem solução</option></select></td>`;
        tabela.appendChild(novaLinha);

        salvarInteressado({nome, cpf, processo, data, telefone, status});
    }

    function mudarStatus(select, processo) {
        const status = select.value;
        let interessados = JSON.parse(localStorage.getItem('interessados') || "[]");
        interessados = interessados.map(i => i.processo === processo ? {...i, status} : i);
        localStorage.setItem('interessados', JSON.stringify(interessados));
        window.open('status.html?status=' + encodeURIComponent(status), '_blank');
    }

    function salvarInteressado(novoInteressado) {
        let interessados = JSON.parse(localStorage.getItem('interessados') || "[]");
        if (!interessados.some(i => i.processo === novoInteressado.processo)) interessados.push(novoInteressado);
        localStorage.setItem('interessados', JSON.stringify(interessados));
    }

    window.onload = function() {
        const interessados = JSON.parse(localStorage.getItem('interessados') || "[]");
        interessados.forEach(i => adicionarLinha(i.nome, i.cpf, i.processo, i.data, i.telefone, i.status));
    };
</script>
</body>
</html>
