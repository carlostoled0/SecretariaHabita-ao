
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de An√°lise | Visualiza√ß√µes Reais</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <h1 class="text-xl font-bold text-blue-600">üìä Painel de An√°lise</h1>
    <nav class="space-x-4 text-sm text-blue-600">
      <a href="index.html">In√≠cio</a>
      <a href="inscritos.html">Inscritos</a>
      <a href="visualizacoes.html">Visualiza√ß√µes</a>
      <a href="videos.html">V√≠deos</a>
      <a href="video.html">An√°lise de V√≠deos</a>
      <a href="roteiro.html">Roteiriza√ß√£o</a>
      <a href="ao-vivo.html">üî¥ Ao Vivo</a>
      <a href="publicidade.html">üì¶ Publicidade</a>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto p-6">
    <section class="mb-6">
      <p class="text-sm text-gray-700">Canal em an√°lise:</p>
      <p id="canalStatus" class="text-sm font-semibold text-gray-600">Carregando...</p>
    </section>

    <section>
      <h2 class="text-lg font-bold text-gray-800 mb-2">üìà Visualiza√ß√µes Reais (√∫ltimos 30 dias)</h2>
      <canvas id="graficoVisualizacoes" height="200"></canvas>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("youtube_token");
      const canalUrl = localStorage.getItem("canal_jairinho_url") || "";
      const canalStatus = document.getElementById("canalStatus");

      if (!token || !canalUrl.includes("@")) {
        canalStatus.innerText = "";
        return;
      }

      const canal = canalUrl.split("@")[1];
      canalStatus.innerHTML = `<strong>@${canal}</strong>`;

      try {
        // Consulta √† YouTube Analytics (dados reais de visualiza√ß√µes)
        const hoje = new Date().toISOString().split("T")[0];
        const dataIni = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0];

        const url = "https://youtubeanalytics.googleapis.com/v2/reports" +
          `?dimensions=day&metrics=views&startDate=${dataIni}&endDate=${hoje}&ids=channel==MINE&sort=day`;

        const res = await fetch(url, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        const data = await res.json();

        if (!data.rows) {
          throw new Error("Sem acesso a dados.");
        }

        const labels = data.rows.map(r => r[0]);
        const valores = data.rows.map(r => r[1]);

        const ctx = document.getElementById("graficoVisualizacoes").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Visualiza√ß√µes (reais)",
              data: valores,
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.1)",
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true }
            }
          }
        });
      } catch (error) {
        document.getElementById("graficoVisualizacoes").remove();
        const fallback = document.createElement("p");
        fallback.className = "text-red-600 text-sm mt-4";
        fallback.innerText = "N√£o foi poss√≠vel acessar os dados reais. Verifique o login OAuth.";
        canalStatus.after(fallback);
      }
    });
  </script>
</body>
</html>
